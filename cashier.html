
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶é“¶ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .section {
            margin-bottom: 25px;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #4CAF50;
            color: #333;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .item-info {
            flex: 1;
        }
        .item-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .item-price {
            color: #666;
            font-size: 14px;
            font-weight: bold;
        }
        .item-quantity {
            color: #666;
            font-size: 14px;
        }
        .total-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #2E7D32;
            margin: 10px 0;
        }
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .modify-btn {
            width: 100%;
            padding: 15px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .submit-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .modal-amount {
            font-size: 48px;
            font-weight: bold;
            color: #2E7D32;
            margin: 20px 0;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        .confirm-btn {
            background: #4CAF50;
            color: white;
            font-size: 20px;
            padding: 15px;
        }
        .cancel-btn {
            background: #f44336;
            color: white;
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .success {
            background: #e8f5e8;
            color: #2E7D32;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .qr-input-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .qr-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .search-btn {
            width: 100%;
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .camera-btn {
            width: 100%;
            padding: 12px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        #camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 1001;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #camera-video {
            width: 100%;
            max-width: 500px;
            height: auto;
        }
        #camera-canvas {
            display: none;
        }
        #close-camera {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1002;
        }
        #scan-instruction {
            color: white;
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
        }
        
        /* ä¿®æ”¹è®¢å•ç•Œé¢æ ·å¼ */
        #editOrderSection {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .category {
            margin-bottom: 20px;
        }
        .category-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #FF9800;
            color: #333;
        }
        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .item-name {
            font-weight: bold;
            flex: 1;
        }
        .item-price {
            color: #666;
            font-weight: bold;
            margin-right: 15px;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quantity-display {
            margin: 0 10px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        .edit-total-section {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .edit-submit-btn {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        /* ä¸²ä¸²é¦™ç›¸å…³æ ·å¼ */
        .skewer-summary {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        .skewer-error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        .flavor-selection {
            background: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .flavor-option {
            margin: 5px 0;
        }
        .flavor-option input {
            margin-right: 8px;
        }
        .flavor-options-container {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        .flavor-option {
            display: flex;
            align-items: center;
            margin: 0;
        }

    </style>
    <!-- å¼•å…¥ jsQR åº“ç”¨äºäºŒç»´ç è¯†åˆ« -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° æ”¶é“¶ç³»ç»Ÿ</h1>
        </div>
        
        <div id="qrInputSection" class="qr-input-section">
            <h2>æ‰«ææˆ–è¾“å…¥è®¢å•å·</h2>
            <input type="text" id="orderIdInput" class="qr-input" placeholder="è¾“å…¥è®¢å•å· (å¦‚: 4)">
            <button id="searchOrder" class="search-btn">æŸ¥è¯¢è®¢å•</button>
            <button id="startCamera" class="camera-btn">æ‰«ç è·å–è®¢å•å·</button>
        </div>
        
        <div id="loading" class="loading hidden">
            æ­£åœ¨åŠ è½½è®¢å•ä¿¡æ¯...
        </div>
        
        <div id="error" class="error hidden"></div>
        <div id="success" class="success hidden"></div>
        
        <!-- è®¢å•è¯¦æƒ…æ˜¾ç¤ºéƒ¨åˆ† -->
        <div id="orderDetails" class="hidden">
            <div class="section">
                <div class="section-title">è®¢å•è¯¦æƒ…</div>
                <div id="orderItems">
                    <!-- è®¢å•å•†å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div id="orderSummary" class="total-section">
                <div>è®¢å•æ€»ä»·:</div>
                <div class="total-amount" id="totalAmount">0 â‚¬</div>
                <button id="modifyOrder" class="modify-btn">ä¿®æ”¹è®¢å•</button>
                <button id="processPayment" class="submit-btn">ç¡®è®¤è®¢å•</button>
            </div>
        </div>
        
        <!-- ä¿®æ”¹è®¢å•ç•Œé¢ -->
        <div id="editOrderSection" class="hidden">
            <h2 class="section-title">ä¿®æ”¹è®¢å•</h2>
            
            <!-- åŒ…å­ç±»åˆ« -->
            <div class="category">
                <div class="category-title">åŒ…å­ (2ä¸ª10â‚¬, å•ä¹°6â‚¬)</div>
                <div id="baoziItems">
                    <!-- åŒ…å­å•†å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- ä¸²ä¸²é¦™ç±»åˆ« -->
            <div class="category">
                <div class="category-title">ä¸²ä¸²é¦™ (æ¯ä»½3ä¸²10â‚¬)</div>
                
                <!-- å£å‘³é€‰æ‹© -->
                <div class="flavor-selection" id="flavorSelection">
                    <strong>å£å‘³é€‰æ‹©</strong>
                    <div class="flavor-options-container">
                        <div class="flavor-option">
                            <input type="radio" id="spicy" name="flavor" value="spicy" checked>
                            <label for="spicy">è¾£å‘³</label>
                        </div>
                        <div class="flavor-option">
                            <input type="radio" id="original" name="flavor" value="original">
                            <label for="original">åŸå‘³</label>
                        </div>
                    </div>
                </div>
                
                <!-- ä¸²ä¸²é¦™æ€»ç»“ -->
                <div class="skewer-summary" id="skewerSummary"></div>
                
                <!-- ä¸²ä¸²é¦™é”™è¯¯æç¤º -->
                <div class="skewer-error hidden" id="skewerError"></div>
                
                <!-- ä¸²ä¸²é¦™ç§ç±» -->
                <div id="skewerItems">
                    <!-- ä¸²ä¸²é¦™ç§ç±»å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- ä¸»é£Ÿç±»åˆ« -->
            <div class="category">
                <div class="category-title">ä¸»é£Ÿ</div>
                <div id="mainCourseItems">
                    <!-- ä¸»é£Ÿå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- å°åƒç±»åˆ« -->
            <div class="category">
                <div class="category-title">å°åƒ</div>
                <div id="snackItems">
                    <!-- å°åƒå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- é¥®æ–™ç±»åˆ« -->
            <div class="category">
                <div class="category-title">é¥®æ–™</div>
                <div id="drinkItems">
                    <!-- é¥®æ–™å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="edit-total-section">
                <div>è®¢å•æ€»ä»·:</div>
                <div class="total-amount" id="editTotalAmount">0 â‚¬</div>
                <button id="submitEdit" class="edit-submit-btn">æäº¤è®¢å•</button>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤æ”¶æ¬¾æ¨¡æ€æ¡† -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2>ç¡®è®¤æ”¶æ¬¾</h2>
            <div>è®¢å•æ€»é‡‘é¢:</div>
            <div class="modal-amount" id="modalAmount">0 â‚¬</div>
            <div class="modal-buttons">
                <button id="confirmPayment" class="modal-btn confirm-btn">ç¡®è®¤æ”¶æ¬¾</button>
                <button id="cancelPayment" class="modal-btn cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ‘„åƒå¤´æ‰«æç•Œé¢ -->
    <div id="camera-container">
        <button id="close-camera">Ã—</button>
        <video id="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas"></canvas>
        <div id="scan-instruction">å°†äºŒç»´ç å¯¹å‡†æ‘„åƒå¤´</div>
    </div>

    <script>
function formatUserId(userId) {
    return userId.toString().padStart(4, '0');
}

        // APIé…ç½® - ä½¿ç”¨ä¸ç‚¹é¤ç³»ç»Ÿç›¸åŒçš„åç«¯
        const API_URL = 'https://script.google.com/macros/s/AKfycbwXlSnBtUaG05GOSfe3h2PJqk2Ax8IDXfpp7zKVNM6JEwHcPfmAzhDGwuDcW4k8Vu8aqQ/exec';
        
        // å…¨å±€å˜é‡
        let currentOrder = null;
        let videoStream = null;
        let scanInterval = null;
        let currentOrderDetails = null;
        let skewerQuantities = {};
        let selectedFlavor = 'spicy'; // é»˜è®¤é€‰æ‹©è¾£å‘³
        
        // å•†å“æ•°æ® - ä¸ç‚¹é¤ç³»ç»Ÿå®Œå…¨ä¸€è‡´
        const baoziTypes = [
            { id: 'baozi-beef', name: 'ç‰›è‚‰åŒ…' },
            { id: 'baozi-pork', name: 'çŒªè‚‰åŒ…' },
            { id: 'baozi-veg', name: 'ç´ èœåŒ…' }
        ];
        
        const skewerTypes = [
            { id: 'skewer-beef', name: 'ç‰›è‚‰' },
            { id: 'skewer-fish-tofu', name: 'é±¼è±†è…' },
            { id: 'skewer-fish-ball', name: 'é±¼ä¸¸' },
            { id: 'skewer-shrimp-ball', name: 'è™¾ä¸¸' },
            { id: 'skewer-crab-stick', name: 'èŸ¹æ£’' },
            { id: 'skewer-quail-egg', name: 'é¹Œé¹‘è›‹' },
            { id: 'skewer-potato', name: 'åœŸè±†ç‰‡' },
            { id: 'skewer-mushroom', name: 'è˜‘è‡' },
            { id: 'skewer-tofu-puff', name: 'è±†è…æ³¡' },
            { id: 'skewer-konjac', name: 'é­”èŠ‹ç»“' }
        ];
        
        const mainCourseItems = [
            { id: 'rice', name: 'å®«ä¿é¸¡ä¸ç±³é¥­', price: 5 }
        ];
        
        const snackItems = [
            { id: 'shrimp-chip', name: 'è™¾ç‰‡', price: 2 }
        ];
        
        const drinkItems = [
            { id: 'coca-cola', name: 'å¯å£å¯ä¹', price: 3 },
            { id: 'mineral-water', name: 'çŸ¿æ³‰æ°´', price: 2 }
        ];
        
        // é¡µé¢åŠ è½½æ—¶è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeSkewers();
        });
        
        // åˆå§‹åŒ–ä¸²ä¸²é¦™æ•°é‡
        function initializeSkewers() {
            skewerTypes.forEach(skewer => {
                skewerQuantities[skewer.id] = 0;
            });
        }

        // æ˜¾ç¤ºä»˜æ¬¾ç¡®è®¤æ¨¡æ€æ¡†
function showPaymentModal() {
    document.getElementById('paymentModal').style.display = 'flex';
}
// éšè—ä»˜æ¬¾ç¡®è®¤æ¨¡æ€æ¡†
function hidePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    document.getElementById('searchOrder').addEventListener('click', searchOrder);
    document.getElementById('processPayment').addEventListener('click', showPaymentModal);
    document.getElementById('confirmPayment').addEventListener('click', confirmPayment);
    document.getElementById('cancelPayment').addEventListener('click', hidePaymentModal);
    document.getElementById('startCamera').addEventListener('click', startCameraScan);
    document.getElementById('close-camera').addEventListener('click', stopCameraScan);
    document.getElementById('modifyOrder').addEventListener('click', showEditOrder);
    document.getElementById('submitEdit').addEventListener('click', submitEditedOrder);
    
    // å£å‘³é€‰æ‹©äº‹ä»¶
    document.querySelectorAll('input[name="flavor"]').forEach(radio => {
        radio.addEventListener('change', function() {
            selectedFlavor = this.value;
        });
    });
    
    // å…è®¸æŒ‰Enteré”®æŸ¥è¯¢è®¢å•
    document.getElementById('orderIdInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchOrder();
        }
    });
    
    // ä¸ºæ•°é‡æŒ‰é’®æ·»åŠ äº‹ä»¶å§”æ‰˜
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('quantity-btn')) {
            handleQuantityChange(e.target);
        }
    });
}
     

        
        // å¯åŠ¨æ‘„åƒå¤´æ‰«æ
        async function startCameraScan() {
            try {
                // è¯·æ±‚æ‘„åƒå¤´æƒé™
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                
                const video = document.getElementById('camera-video');
                video.srcObject = videoStream;
                
                // æ˜¾ç¤ºæ‘„åƒå¤´ç•Œé¢
                document.getElementById('camera-container').style.display = 'flex';
                
                // å¼€å§‹æ‰«æ
                startQRScanning();
            } catch (error) {
                console.error('æ‘„åƒå¤´é”™è¯¯:', error);
                showError('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + error.message);
            }
        }
        
        // å¼€å§‹äºŒç»´ç æ‰«æ
        function startQRScanning() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');
            
            scanInterval = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // ç»˜åˆ¶è§†é¢‘å¸§åˆ°canvas
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // è·å–å›¾åƒæ•°æ®
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // ä½¿ç”¨jsQRè¯†åˆ«äºŒç»´ç 
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        // æ‰¾åˆ°äºŒç»´ç ï¼Œæå–è®¢å•å·
                        const orderId = code.data.trim();
                        console.log('æ‰«æåˆ°è®¢å•å·:', orderId);
                        
                        // åœæ­¢æ‰«æ
                        stopCameraScan();
                        
                        // è‡ªåŠ¨å¡«å…¥è®¢å•å·å¹¶æŸ¥è¯¢
                        document.getElementById('orderIdInput').value = orderId;
                        searchOrder();
                    }
                }
            }, 100); // æ¯100æ¯«ç§’æ‰«æä¸€æ¬¡
        }
        
        // åœæ­¢æ‘„åƒå¤´æ‰«æ
        function stopCameraScan() {
            // æ¸…é™¤æ‰«æé—´éš”
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            // åœæ­¢è§†é¢‘æµ
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            // éšè—æ‘„åƒå¤´ç•Œé¢
            document.getElementById('camera-container').style.display = 'none';
        }
        
       
    // æŸ¥è¯¢è®¢å•
async function searchOrder() {
document.getElementById('editOrderSection').classList.add('hidden');
    const orderIdInput = document.getElementById('orderIdInput').value.trim();

    if (!orderIdInput) {
        showError('è¯·è¾“å…¥è®¢å•å·');
        return;
    }

    // è½¬ä¸ºæ•°å­—å†æ ¼å¼åŒ–ä¸º 4 ä½å­—ç¬¦ä¸²
const orderIdNum = parseInt(orderIdInput);
if (isNaN(orderIdNum)) {
    showError('è®¢å•å·å¿…é¡»æ˜¯æ•°å­—');
    return;
}
const orderId = formatUserId(orderIdNum);


    showLoading();
    hideError();
    hideSuccess();

    try {
        const response = await fetch(`${API_URL}?action=getOrders`);
        const data = await response.json();

        if (data.orders && Array.isArray(data.orders)) {
            // æŸ¥æ‰¾åŒ¹é…è®¢å• - ä½¿ç”¨æ ¼å¼åŒ–åçš„ 4 ä½å­—ç¬¦ä¸²
            const order = data.orders.find(o => o.userId === orderId);

            if (order) {
                if (order.status === 'paid') {
                    showError('æ­¤è®¢å•å·²ä»˜æ¬¾');
                } else if (order.status === 'completed') {
                    showError('æ­¤è®¢å•å·²å®Œæˆ');
                } else {
                    currentOrder = order;
                    currentOrderDetails = JSON.parse(order.orderDetails);
                    displayOrderDetails(order);
                    hideLoading();
                    document.getElementById('orderDetails').classList.remove('hidden');
                }
            } else {
                hideLoading();
                showError('æœªæ‰¾åˆ°è¯¥è®¢å•å·ã€‚è¯·ç¡®è®¤è®¢å•å·æ­£ç¡®ä¸”è®¢å•å·²åˆ›å»ºã€‚');
            }
        } else {
            hideLoading();
            showError('è·å–è®¢å•æ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        hideLoading();
        console.error('APIé”™è¯¯:', error);
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    }
}
        
        // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
        function displayOrderDetails(order) {
            // è§£æè®¢å•è¯¦æƒ…
            let orderDetails;
            try {
                orderDetails = JSON.parse(order.orderDetails);
                console.log('è®¢å•è¯¦æƒ…:', orderDetails); // è°ƒè¯•ä¿¡æ¯
            } catch (e) {
                console.error('è§£æè®¢å•è¯¦æƒ…é”™è¯¯:', e);
                orderDetails = {};
            }
            
            const orderItemsElement = document.getElementById('orderItems');
            orderItemsElement.innerHTML = '';
            
            // æ˜¾ç¤ºåŒ…å­
            if (orderDetails.baozi) {
                for (const [name, quantity] of Object.entries(orderDetails.baozi)) {
                    if (quantity > 0) {
                        const price = getBaoziPrice(quantity);
                        addOrderItem(name, quantity, price);
                    }
                }
            }
            
            // æ˜¾ç¤ºä¸²ä¸²é¦™
            if (orderDetails.skewers && orderDetails.skewers.totalPortions > 0) {
                const portions = orderDetails.skewers.totalPortions;
                const flavor = orderDetails.skewers.flavor === 'spicy' ? 'è¾£å‘³' : 'åŸå‘³';
                addOrderItem(`ä¸²ä¸²é¦™ (${flavor})`, portions, portions * 10);
            }
            
            // æ˜¾ç¤ºå…¶ä»–å•†å“
            if (orderDetails.others) {
                for (const [name, quantity] of Object.entries(orderDetails.others)) {
                    if (quantity > 0) {
                        const price = getOtherItemPrice(name, quantity);
                        addOrderItem(name, quantity, price);
                    }
                }
            }
            
            // æ˜¾ç¤ºé¥®æ–™
            if (orderDetails.drinks) {
                for (const [name, quantity] of Object.entries(orderDetails.drinks)) {
                    if (quantity > 0) {
                        const price = getDrinkPrice(name, quantity);
                        addOrderItem(name, quantity, price);
                    }
                }
            }
            
            // æ›´æ–°æ€»ä»·
            document.getElementById('totalAmount').textContent = order.totalAmount + ' â‚¬';
            document.getElementById('modalAmount').textContent = order.totalAmount + ' â‚¬';
        }
        
        // æ·»åŠ è®¢å•é¡¹ç›®
        function addOrderItem(name, quantity, price) {
            const orderItemsElement = document.getElementById('orderItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'order-item';
            
            itemDiv.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${name}</div>
                    <div class="item-quantity">æ•°é‡: ${quantity}</div>
                </div>
                <div class="item-price">${price} â‚¬</div>
            `;
            
            orderItemsElement.appendChild(itemDiv);
        }
        
        // è®¡ç®—åŒ…å­ä»·æ ¼ - ä¸ç‚¹é¤ç³»ç»Ÿå®Œå…¨ä¸€è‡´
        function getBaoziPrice(quantity) {
            const pairs = Math.floor(quantity / 2);
            const singles = quantity % 2;
            return pairs * 10 + singles * 6;
        }
        
        // è®¡ç®—å…¶ä»–å•†å“ä»·æ ¼ - ä¸ç‚¹é¤ç³»ç»Ÿå®Œå…¨ä¸€è‡´
        function getOtherItemPrice(name, quantity) {
            if (name === 'å®«ä¿é¸¡ä¸ç±³é¥­') {
                return quantity * 5;
            } else if (name === 'è™¾ç‰‡') {
                return quantity * 2;
            }
            return 0;
        }
        
        // è®¡ç®—é¥®æ–™ä»·æ ¼ - ä¸ç‚¹é¤ç³»ç»Ÿå®Œå…¨ä¸€è‡´
        function getDrinkPrice(name, quantity) {
            if (name === 'å¯å£å¯ä¹') {
                return quantity * 3;
            } else if (name === 'çŸ¿æ³‰æ°´') {
                return quantity * 2;
            }
            return 0;
        }
        
        // æ˜¾ç¤ºä¿®æ”¹è®¢å•ç•Œé¢
        function showEditOrder() {
            if (!currentOrderDetails) return;
            
            // éšè—è®¢å•è¯¦æƒ…ï¼Œæ˜¾ç¤ºä¿®æ”¹ç•Œé¢
            document.getElementById('orderDetails').classList.add('hidden');
            document.getElementById('editOrderSection').classList.remove('hidden');
            
            // å¡«å……åŒ…å­å•†å“
            const baoziItemsElement = document.getElementById('baoziItems');
            baoziItemsElement.innerHTML = '';
            
            baoziTypes.forEach(item => {
                const quantity = currentOrderDetails.baozi && currentOrderDetails.baozi[item.name] 
                    ? currentOrderDetails.baozi[item.name] 
                    : 0;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">å•ä¹° 6â‚¬</div>
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-item="${item.name}" data-type="baozi">-</button>
                        <span class="quantity-display" id="${item.name}Quantity">${quantity}</span>
                        <button class="quantity-btn plus" data-item="${item.name}" data-type="baozi">+</button>
                    </div>
                `;
                baoziItemsElement.appendChild(itemDiv);
            });
            
            // å¡«å……ä¸²ä¸²é¦™
            const skewerItemsElement = document.getElementById('skewerItems');
            skewerItemsElement.innerHTML = '';
            
            // è®¾ç½®å£å‘³
            if (currentOrderDetails.skewers && currentOrderDetails.skewers.flavor) {
                selectedFlavor = currentOrderDetails.skewers.flavor;
                document.querySelector(`input[name="flavor"][value="${selectedFlavor}"]`).checked = true;
            }
            
            // å¡«å……ä¸²ä¸²é¦™ç§ç±»
            skewerTypes.forEach(skewer => {
                const quantity = currentOrderDetails.skewers && currentOrderDetails.skewers[skewer.name] 
                    ? currentOrderDetails.skewers[skewer.name] 
                    : 0;
                
                skewerQuantities[skewer.id] = quantity;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <div class="item-name">${skewer.name}</div>
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-item="${skewer.id}" data-type="skewers">-</button>
                        <span class="quantity-display" id="${skewer.id}Quantity">${quantity}</span>
                        <button class="quantity-btn plus" data-item="${skewer.id}" data-type="skewers">+</button>
                    </div>
                `;
                skewerItemsElement.appendChild(itemDiv);
            });
            
            // æ›´æ–°ä¸²ä¸²é¦™æ€»ç»“
            updateSkewerSummary();
            
            // å¡«å……ä¸»é£Ÿ
            const mainCourseItemsElement = document.getElementById('mainCourseItems');
            mainCourseItemsElement.innerHTML = '';
            
            mainCourseItems.forEach(item => {
                const quantity = currentOrderDetails.others && currentOrderDetails.others[item.name] 
                    ? currentOrderDetails.others[item.name] 
                    : 0;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${item.price} â‚¬</div>
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-item="${item.name}" data-type="others">-</button>
                        <span class="quantity-display" id="${item.name}Quantity">${quantity}</span>
                        <button class="quantity-btn plus" data-item="${item.name}" data-type="others">+</button>
                    </div>
                `;
                mainCourseItemsElement.appendChild(itemDiv);
            });
            
            // å¡«å……å°åƒ
            const snackItemsElement = document.getElementById('snackItems');
            snackItemsElement.innerHTML = '';
            
            snackItems.forEach(item => {
                const quantity = currentOrderDetails.others && currentOrderDetails.others[item.name] 
                    ? currentOrderDetails.others[item.name] 
                    : 0;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${item.price} â‚¬</div>
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-item="${item.name}" data-type="others">-</button>
                        <span class="quantity-display" id="${item.name}Quantity">${quantity}</span>
                        <button class="quantity-btn plus" data-item="${item.name}" data-type="others">+</button>
                    </div>
                `;
                snackItemsElement.appendChild(itemDiv);
            });
            
            // å¡«å……é¥®æ–™
            const drinkItemsElement = document.getElementById('drinkItems');
            drinkItemsElement.innerHTML = '';
            
            drinkItems.forEach(item => {
                const quantity = currentOrderDetails.drinks && currentOrderDetails.drinks[item.name] 
                    ? currentOrderDetails.drinks[item.name] 
                    : 0;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${item.price} â‚¬</div>
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-item="${item.name}" data-type="drinks">-</button>
                        <span class="quantity-display" id="${item.name}Quantity">${quantity}</span>
                        <button class="quantity-btn plus" data-item="${item.name}" data-type="drinks">+</button>
                    </div>
                `;
                drinkItemsElement.appendChild(itemDiv);
            });
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºæ€»ä»·
            updateEditTotal();
        }
        
        // å¤„ç†æ•°é‡å˜åŒ–
        function handleQuantityChange(button) {
            const isPlus = button.classList.contains('plus');
            const item = button.getAttribute('data-item');
            const type = button.getAttribute('data-type');
            
            const quantityElement = document.getElementById(`${item}Quantity`);
            let quantity = parseInt(quantityElement.textContent);
            
            if (isPlus) {
                quantity++;
            } else {
                quantity = Math.max(0, quantity - 1);
            }
            
            quantityElement.textContent = quantity;
            
            // æ›´æ–°å½“å‰è®¢å•è¯¦æƒ…
            if (type === 'skewers') {
                skewerQuantities[item] = quantity;
                updateSkewerSummary();
            } else {
                if (!currentOrderDetails[type]) {
                    currentOrderDetails[type] = {};
                }
                currentOrderDetails[type][item] = quantity;
            }
            
            // æ›´æ–°æ€»ä»·
            updateEditTotal();
        }

   function updateEditTotal() {
    let total = 0;

    // åŒ…å­ä»·æ ¼
    let totalBaozi = 0;
    if (currentOrderDetails.baozi) {
        for (const qty of Object.values(currentOrderDetails.baozi)) {
            totalBaozi += parseInt(qty) || 0;
        }
    }
    if (totalBaozi > 0) {
        const pairs = Math.floor(totalBaozi / 2);
        const singles = totalBaozi % 2;
        total += pairs * 10 + singles * 6;
    }

    // ä¸²ä¸²é¦™ä»·æ ¼
    const totalSkewers = Object.values(skewerQuantities).reduce((sum, qty) => sum + qty, 0);
    const portions = Math.floor(totalSkewers / 3);
    total += portions * 10; // æ¯ä»½ 3 ä¸² 10â‚¬

    // å…¶ä»–å•†å“
    if (currentOrderDetails.others) {
        for (const [name, qty] of Object.entries(currentOrderDetails.others)) {
            if (qty > 0) total += getOtherItemPrice(name, qty);
        }
    }

    // é¥®æ–™
    if (currentOrderDetails.drinks) {
        for (const [name, qty] of Object.entries(currentOrderDetails.drinks)) {
            if (qty > 0) total += getDrinkPrice(name, qty);
        }
    }

    // æ›´æ–°ç•Œé¢
    document.getElementById('editTotalAmount').textContent = total + ' â‚¬';
}





        // æ›´æ–°ä¸²ä¸²é¦™æ€»ç»“
function updateSkewerSummary() {
    const totalSkewers = Object.values(skewerQuantities).reduce((sum, qty) => sum + qty, 0);
    const portions = Math.floor(totalSkewers / 3);
    const remainder = totalSkewers % 3;
    
    const summaryDiv = document.getElementById('skewerSummary');
    const errorDiv = document.getElementById('skewerError');
    const submitBtn = document.getElementById('submitEdit'); // æäº¤æŒ‰é’®

    // æ›´æ–°ä¸²ä¸²é¦™æ€»ç»“ä¿¡æ¯
    summaryDiv.innerHTML = `
        <div style="font-size: 16px; font-weight: bold;">
            å½“å‰ä¸²æ•°: ${totalSkewers} | ä»½æ•°: ${portions}
        </div>
    `;

    // å¦‚æœä¸²ä¸²æ•°é‡é3çš„å€æ•°ä¸”å¤§äº0ï¼Œæ˜¾ç¤ºé”™è¯¯å¹¶ç¦ç”¨æŒ‰é’®
    if (totalSkewers > 0 && remainder !== 0) {
        errorDiv.textContent = 'ä¸²ä¸²é¦™æ•°é‡å¿…é¡»æ˜¯3çš„å€æ•°';
        errorDiv.classList.remove('hidden');

        // ç¦ç”¨æäº¤æŒ‰é’®
        submitBtn.disabled = true;
        submitBtn.style.background = '#cccccc';
    } else {
        // éšè—é”™è¯¯æç¤º
        errorDiv.classList.add('hidden');

        // å¯ç”¨æäº¤æŒ‰é’®
        submitBtn.disabled = false;
        submitBtn.style.background = '#4CAF50';
    }

    // åŒæ—¶æ›´æ–°ç¼–è¾‘ç•Œé¢æ€»ä»·
    updateEditTotal();
}

        
// æäº¤ä¿®æ”¹åçš„è®¢å•
async function submitEditedOrder() {
    if (!currentOrder || !currentOrderDetails) return;
    
    // æ£€æŸ¥ä¸²ä¸²é¦™æ•°é‡æ˜¯å¦ä¸º3çš„å€æ•°
    const totalSkewers = Object.values(skewerQuantities).reduce((sum, qty) => sum + qty, 0);
    if (totalSkewers > 0 && totalSkewers % 3 !== 0) {
        showError('ä¸²ä¸²é¦™æ•°é‡å¿…é¡»æ˜¯3çš„å€æ•°');
        return;
    }
    
    showLoading();
    
    try {
        // è®¡ç®—æ€»ä»·
        const totalAmount = parseFloat(document.getElementById('editTotalAmount').textContent.replace(' â‚¬', ''));

        
        // æ›´æ–°ä¸²ä¸²é¦™æ•°æ®
        if (!currentOrderDetails.skewers) {
            currentOrderDetails.skewers = {};
        }
        
        currentOrderDetails.skewers.flavor = selectedFlavor;
        currentOrderDetails.skewers.totalPortions = Math.floor(totalSkewers / 3);
        
        // æ·»åŠ ä¸²ä¸²é¦™ç§ç±»æ•°é‡
        skewerTypes.forEach(skewer => {
            currentOrderDetails.skewers[skewer.name] = skewerQuantities[skewer.id];
        });
        
        // æ›´æ–°è®¢å•åˆ°åç«¯
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=updateOrder&userId=${formatUserId(currentOrder.userId)}&orderDetails=${encodeURIComponent(JSON.stringify(currentOrderDetails))}&totalAmount=${encodeURIComponent(totalAmount)}`

        });
        
        const data = await response.json();
        console.log('æ›´æ–°è®¢å•å“åº”:', data); // è°ƒè¯•ä¿¡æ¯
        
        if (data.success || data.message) {
            // æ›´æ–°å½“å‰è®¢å•
            currentOrder.orderDetails = JSON.stringify(currentOrderDetails);
            currentOrder.totalAmount = totalAmount;
            
            // éšè—ä¿®æ”¹ç•Œé¢ï¼Œæ˜¾ç¤ºè®¢å•è¯¦æƒ…
            document.getElementById('editOrderSection').classList.add('hidden');
            document.getElementById('orderDetails').classList.remove('hidden');
            
            // æ›´æ–°è®¢å•è¯¦æƒ…æ˜¾ç¤º
            displayOrderDetails(currentOrder);
            
            hideLoading();
            showSuccess('è®¢å•ä¿®æ”¹æˆåŠŸï¼');
        } else {
            hideLoading();
            showError('æ›´æ–°è®¢å•å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        hideLoading();
        console.error('æ›´æ–°è®¢å•é”™è¯¯:', error); // è°ƒè¯•ä¿¡æ¯
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    }
}

// ç¡®è®¤æ”¶æ¬¾
async function confirmPayment() {
    if (!currentOrder) {
        showError('æ²¡æœ‰å¯å¤„ç†çš„è®¢å•');
        return;
    }
    
    showLoading();
    hidePaymentModal();
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
           body: `action=updateOrderStatus&userId=${formatUserId(currentOrder.userId)}&status=paid`

        });
        
        const data = await response.json();
        console.log('æ›´æ–°è®¢å•çŠ¶æ€å“åº”:', data); // è°ƒè¯•ä¿¡æ¯
        
        if (data.success || data.message) {
            hideLoading();
            showSuccess('æ”¶æ¬¾æˆåŠŸï¼è®¢å•å·²å‘é€åˆ°åå¨');
            document.getElementById('orderDetails').classList.add('hidden');
            document.getElementById('orderIdInput').value = '';
            currentOrder = null;
            currentOrderDetails = null;
        } else {
            hideLoading();
            showError('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        hideLoading();
        console.error('æ›´æ–°è®¢å•çŠ¶æ€é”™è¯¯:', error); // è°ƒè¯•ä¿¡æ¯
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    }
}
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }
        
        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }
        
        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const successElement = document.getElementById('success');
            successElement.textContent = message;
            successElement.classList.remove('hidden');
        }
        
        // éšè—æˆåŠŸä¿¡æ¯
        function hideSuccess() {
            document.getElementById('success').classList.add('hidden');
        }
    </script>
</body>
</html>